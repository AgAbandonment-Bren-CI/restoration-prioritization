---
title: "Prioritization of cropland restoration"
authors: "Nick McManus and Michelle Geldin"
date: '2022-10-13'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(prioritizr)    # optimization software! 
library(terra)         # for reading in and altering rasters
library(sf)            
library(raster)        # for formating rasters in prioritizr-friendly format
library(geobr)         # geometries for Brazilian biomes
library(ggplot2)       # visualize some outputs
library(tidyverse)     # always!
library(janitor)
```

## Read in data{.tabset}

### Planning Units

```{r}
# read in planning units for SSP1
ssp1_pu <- st_read("data/inputs/ssp1/ssp1_pu.shp") %>% 
  clean_names() %>% 
  
  # only keep select columns of interest
  select(join_count, target_fid, bioma, cd_bioma, shape_area) %>% 
  
  # rename some columns to make later merging easier
  rename(id = target_fid,
         biome_code = cd_bioma,
         biome = bioma) %>%
  
  #remove pus that are located outside Brazil biome boundaries
  filter(join_count != 0)

# read in planning units for SSP2 -------------------------------------------
ssp2_pu <- read_sf("data/inputs/ssp2/ssp2_pu.shp") %>% 
  clean_names() %>% 
  select(join_count, target_fid, bioma, cd_bioma, shape_area) %>% 
  rename(id = target_fid,
         biome_code = cd_bioma,
         biome = bioma) %>%
  filter(join_count != 0)

# read in planning units for SSP3 -------------------------------------------
ssp3_pu <- read_sf("data/inputs/ssp3/ssp3_pu.shp") %>% 
  clean_names() %>% 
  select(join_count, target_fid, bioma, cd_bioma, shape_area) %>% 
  rename(id = target_fid,
         biome_code = cd_bioma,
         biome = bioma) %>%
  filter(join_count != 0)

# read in planning units for SSP4 -------------------------------------------
ssp4_pu <- read_sf("data/inputs/ssp4/ssp4_pu.shp") %>% 
  clean_names() %>% 
  select(join_count, target_fid, bioma, cd_bioma, shape_area) %>% 
  rename(id = target_fid,
         biome_code = cd_bioma,
         biome = bioma) %>%
  filter(join_count != 0)

# read in planning units for SSP5 -------------------------------------------
ssp5_pu <- read_sf("data/inputs/ssp5/ssp5_pu.shp") %>% 
  clean_names() %>% 
  select(join_count, target_fid, bioma, cd_bioma, shape_area) %>% 
  rename(id = target_fid,
         biome_code = cd_bioma,
         biome = bioma) %>%
  filter(join_count != 0)
```


### Cropland Abandonment
Read in areas of projected cropland abandonment for five different SSP scenarios in Brazil. This data was generated from code located in the `abandoned-cropland` repository.
- may delete this chunk later if no longer necessary
```{r}
# read in the cropland abandonment
ssp1_abandoned_crop <- rast("data/inputs/ssp1/SSP1_abandoned_cropland_brazil.tif")
ssp2_abandoned_crop <- rast("data/inputs/ssp2/SSP2_abandoned_cropland_brazil.tif")
ssp3_abandoned_crop <- rast("data/inputs/ssp3/SSP3_abandoned_cropland_brazil.tif")
ssp4_abandoned_crop <- rast("data/inputs/ssp4/SSP4_abandoned_cropland_brazil.tif")
ssp5_abandoned_crop <- rast("data/inputs/ssp5/SSP5_abandoned_cropland_brazil.tif")
```


### Biome boundaries

The boundary information for Brazilian biomes is read-in using the geobr package. Biome polygons are sourced from the Brazilian Institute of Geography and Statistics (IBGE). This dataset uses 2019 IBGE data at scale 1:250.000.

Source: https://www.ibge.gov.br/geociencias/cartas-e-mapas/informacoes-ambientais/15842-biomas.html?=&t=acesso-ao-produto

```{r}
# read in biome boundaries from geobr package
biomes <- read_biomes(
  year = 2019,         #the most recent data available
  simplified = FALSE   #full resolution for boundaries
)

#remove coastal system biome
biomes_vect <- biomes[-7, ] %>%  
  
  #change crs to match other rasters
  st_transform(crs = crs(ssp1_abandoned_crop)) %>%
  
  #turn sf into vector so it's easier to crop and mask with
  vect()   
```


### Carbon sequestraion rates
Read in global carbon sequestration layer. Data sources from XYZ.....

After reading in the global layer, we will crop it to Brazil and save the outputs. 
```{r, eval=FALSE}
#NOTE: this code chunk defaults to not evaluate.
#only needs to be run once and cropped raster is saved

# read in carbon layer
carbon_global <- rast("data/inputs/sequestration_rate__mean__aboveground__full_extent__Mg_C_ha_yr.tif")

#temporarily change biome crs to crop/mask carbon data
#faster than changing crs of global raster
brazil_trans <- biomes_vect %>% 
  project(y = crs(carbon_global))

# crop carbon data to Brazil
carbon_brazil <- carbon_global %>% 
  crop(brazil_trans) %>% 
  mask(brazil_trans) %>%  
  #change crs back to match other rasters
  terra::project(y = crs(biomes_vect)) 

# default resolution of carbon layer is 898.8m
# change resolution to match other rasters (1km)
carbon_brazil <- resample(carbon_brazil, ssp1_abandoned_crop, method = "bilinear")

# test plot to visualize results
plot(carbon_brazil)

#export carbon_brazil as intermediate raster
writeRaster(carbon_brazil, "data/outputs/carbon_seq_rate_Brazil.tif")

#-----------------------------------------------------------------------------
# run below line of code just to read in layer if already created
carbon_brazil <- rast("data/outputs/carbon_seq_rate_Brazil.tif")
```


### Biodiversity
Read in biodiversity data. Info about the data and where it is from. 

After reading in the global layer, we will crop it to Brazil, resample to match the resolution of the planning units, and save the output raster. 

```{r, eval=FALSE}
#NOTE: this code chunk defaults to not evaluate.
#only needs to be run once and then cropped raster is saved

#read in global biodiversity data
biodiversity_global <- rast("data/inputs/sparc_conservationPriorities.tif")

#temporarily change biome crs to crop/mask biodiversity data
#faster than changing crs of global raster
brazil_trans <- biomes_vect %>% 
  project(y = crs(biodiversity_global))

# crop biodiversity layer to Brazil
biodiversity_brazil <- biodiversity_global %>% 
  crop(brazil_trans) %>% 
  mask(brazil_trans) %>% 
  #change crs back to match other rasters
  terra::project(y = crs(biomes_vect))

# change resolution of biodiversity layer (4.72km) to match other rasters (1km)
biodiversity_brazil <- resample(biodiversity_brazil, ssp1_abandoned_crop, method = "bilinear")

# test plot to visualize results
plot(biodiversity_brazil)

#export biodiversity_brazil as intermediate raster
writeRaster(biodiversity_brazil, "data/outputs/sparc_conservationPriorities_Brazil.tif")

#--------------------------------------------------------------------------------------
# run below line of code just to read in layer if already created
biodiversity_brazil <- rast("data/outputs/sparc_conservationPriorities_Brazil.tif")
```


### Cost Layer

```{r}
#read in cost data
costs <- read_csv("data/inputs/tnc_cost_biomes_methods.csv") %>% 
  clean_names()
```

#### Merge Cost and PU

Decide on the restoration method and land status desired to analyze the cost, then merge to assign costs to each planning unit
```{r}
# select the restoration method and land status you want to use

# Looking at conducting natural regeneration and "unfavorable environmental conditions" (CAD)
costs_cnr_cad <- costs %>% 
  filter(restoration_method == "conducting_natural_regeneration") %>% 
  filter(environmental_conditions == "CAD") %>% 
  select(!c(id, biome))  #remove id and biome columns



# now merge the filtered cost with planning units for each SSP

ssp1_pu_costs <- ssp1_pu %>% 
  full_join(costs_cnr_cad, by = "biome_code") %>%  #merge objects
  relocate(geometry, .after = environmental_conditions)    #moves geometry column to end
 #st_drop_geometry()   #may want to just drop geometry altogether? 

ssp2_pu_costs <- ssp2_pu %>% 
  full_join(costs_cnr_cad, by = c("biome_code")) %>% 
  relocate(geometry, .after = environmental_conditions)   

ssp3_pu_costs <- ssp3_pu %>% 
  full_join(costs_cnr_cad, by = c("biome_code")) %>% 
  relocate(geometry, .after = environmental_conditions)  

ssp4_pu_costs <- ssp4_pu %>% 
  full_join(costs_cnr_cad, by = c("biome_code")) %>% 
  relocate(geometry, .after = environmental_conditions) 

ssp5_pu_costs <- ssp5_pu %>% 
  full_join(costs_cnr_cad, by = c("biome_code")) %>% 
  relocate(geometry, .after = environmental_conditions)  
```


## Problem Formulations

This is where we will start formulating the problem to be solved in prioritizr!
```{r}
problem_ssp1 <- problem(ssp1_pu_costs, 
                        features = biodiversity_brazil, 
                        cost_column = "cost_usd_ha") %>% 
  add_min_set_objective() %>% 
  add_boundary_penalties() %>%
  add_relative_targets() %>% 
  add_locked_in_constraints() %>% 
  add_binary_decisions()



```
 









